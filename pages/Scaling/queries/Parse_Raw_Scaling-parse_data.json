{
  "pluginType": "JS",
  "pluginId": "js-plugin",
  "unpublishedAction": {
    "name": "parse_data",
    "fullyQualifiedName": "Parse_Raw_Scaling.parse_data",
    "datasource": {
      "name": "UNUSED_DATASOURCE",
      "pluginId": "js-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "Scaling",
    "collectionId": "Scaling_Parse_Raw_Scaling",
    "actionConfiguration": {
      "timeoutInMillisecond": 10000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "async () => {\n  var dupes = 0;\n  try {\n    console.log(\"starting\");\n    console.log(\"mapping\");\n    const scale_data = Select_Raw_Scaling.data;\n    console.log(\"got raw scaling\");\n    const log_set = new Set(Logs.data.map(item => item.Log));\n    console.log(\"logs loaded\");\n    const ilog_set = new Set(ILogs.data.map(item => item.Log));\n    console.log(\"got ILogs\");\n    const rlog_set = new Set(RLogs.data.map(item => item.Log));\n    console.log(\"got RLogs\");\n    const len_set = new Set(Lengths.data.map(item => item.Lengths));\n    console.log(\"got Lengths\");\n    const docket_set = new Set(Dockets.data.map(item => item.Docket));\n    console.log(\"got Dockets\");\n    const grade_set = new Set(Grade.data.map(item => item.Grade));\n    console.log(\"got Grades\");\n    const location_set = new Set(Location.data.map(item => item.Location));\n    console.log(\"got Locations\");\n    const new_Location = new Set();\n    const new_Location_Added = {};\n    console.log(\"data loaded\");\n    const {iv_scale, scale, reject} = scale_data.reduce((acc, sr) => {\n      const invalid = reason => {\n        if (!ilog_set.has(sr.Log)) {\n          sr.Reason += reason;\n          acc.iv_scale.push([sr.Log, sr.Docket, sr.Grade, sr.Length, sr.Diameter, sr.JAS, sr.Location, sr.Date, sr.Reason]);\n        }\n      };\n      const valid = () => acc.scale.push([sr.Log, sr.Docket, sr.Grade, sr.Length, sr.Diameter, sr.JAS, sr.Location, sr.Date]);\n      const reject = () => {\n        if (!rlog_set.has(sr.Log)) {\n          acc.reject.push([sr.Log, sr.Docket, sr.Grade, sr.Length, sr.Diameter, sr.JAS, sr.Date, sr.Reason]);\n        }\n      };\n      sr.Log = parseInt(sr.Log.replace(/\\D/g, ''));\n      if (!log_set.has(sr.Log)) {\n        sr.Date = sr.Date.split('-').reverse().join(\"-\");\n        sr.Location = sr.Location.replace(/ /g, '').toUpperCase();\n        sr.Location = sr.Location.slice(0, 4) + \" \" + sr.Location.slice(-3);\n        if (!location_set.has(sr.Location) && sr.Location && sr.Location != 'TEST' && sr.Location != 'REJE TED') {\n          new_Location.add(sr.Location);\n          new_Location_Added[sr.Location] = sr.Date;\n          location_set.add(sr.Location);\n        }\n        if (isNaN(sr.Docket)) {\n          invalid(\" Invalid Docket Format\");\n        } else if (!docket_set.has(parseInt(sr.Docket))) {\n          invalid(\" Docket Not Found\");\n        } else if (sr.Status === 'Rejected') {\n          reject();\n        } else if (!location_set.has(sr.Location) || sr.Location === 'TEST') {\n          invalid(\" Invalid Location\");\n        } else if (sr.Diameter < 16 || sr.Diameter > 50 || isNaN(sr.Diameter)) {\n          invalid(' Diameter out of range or NaN');\n        } else if (!len_set.has(sr.Length.toString())) {\n          invalid(\" Invalid Length\", sr.Length);\n        } else if (!grade_set.has(sr.Grade)) {\n          invalid(\" Invalid Grade\");\n        } else {\n          valid();\n        }\n      } else {\n        dupes += 1;\n        if (dupes < 5) {\n          showAlert(\"Duplicate Log \" + sr.Log.toString(), 'error');\n        }\n      }\n      return acc;\n    }, {\n      scale: [],\n      iv_scale: [],\n      reject: []\n    });\n    if (dupes > 4) {\n      showAlert(\"Multiple Duplicate Logs - clear raw scaling and start again\", 'error');\n    }\n    console.log(\"finished processing\");\n    if (new_Location.size) {\n      const location_data = Array.from(new_Location).map(item => `('${item}','','${new_Location_Added[item]}')`).join(',').replace(/''/g, 'NULL');\n      await Insert_Yard.run({\n        'data': location_data\n      }).then(() => showAlert(\"Inserted New Locations ${location_data}\", 'success')).error(error => showAlert(error, 'error'));\n      await Location.clear();\n      await Location.run();\n      console.log(\"Inserted Locations\");\n    }\n    if (scale.length > 0) {\n      const data = scale.map(item => `(${item.map(val => `'${val}'`).join(',')})`).join(',');\n      console.log('Valid :', scale.length);\n      await Insert_VScaling.run({\n        'data': data\n      }).then(() => showAlert(\"Found Valid Scaling Entires\", 'success')).catch(() => showAlert(\"Error in adding Valid\", 'error'));\n    }\n    if (iv_scale.length > 0) {\n      const idata = iv_scale.map(item => `(${item.map(val => `'${val}'`).join(',')})`).join(',');\n      console.log('Invalid: ', iv_scale.length);\n      await Insert_Invalid_Scaling.run({\n        'data': idata\n      }).then(() => showAlert(\"Found Invalid Scaling Entires\", 'success')).catch(() => showAlert(\"Error in adding invalid\", 'error'));\n    }\n    if (reject.length > 0) {\n      const rdata = reject.map(item => `(${item.map(val => `'${val}'`).join(',')})`).join(',');\n      console.log('Rejects : ', reject.length);\n      await Insert_Reject_Scaling.run({\n        'data': rdata\n      }).then(() => showAlert(\"Found Reject Scaling Entires\", 'success')).catch(() => showAlert(\"Error in adding reject\", 'error'));\n    }\n    console.log(\"recounting totals\");\n    return 'successfully updated';\n  } catch (error) {\n    showAlert(\"Processing Error\", 'error');\n    return Error();\n  }\n}",
      "selfReferencingDataPaths": [],
      "jsArguments": [],
      "isAsync": true
    },
    "executeOnLoad": false,
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [
      "async () => {\n  var dupes = 0;\n  try {\n    console.log(\"starting\");\n    console.log(\"mapping\");\n    const scale_data = Select_Raw_Scaling.data;\n    console.log(\"got raw scaling\");\n    const log_set = new Set(Logs.data.map(item => item.Log));\n    console.log(\"logs loaded\");\n    const ilog_set = new Set(ILogs.data.map(item => item.Log));\n    console.log(\"got ILogs\");\n    const rlog_set = new Set(RLogs.data.map(item => item.Log));\n    console.log(\"got RLogs\");\n    const len_set = new Set(Lengths.data.map(item => item.Lengths));\n    console.log(\"got Lengths\");\n    const docket_set = new Set(Dockets.data.map(item => item.Docket));\n    console.log(\"got Dockets\");\n    const grade_set = new Set(Grade.data.map(item => item.Grade));\n    console.log(\"got Grades\");\n    const location_set = new Set(Location.data.map(item => item.Location));\n    console.log(\"got Locations\");\n    const new_Location = new Set();\n    const new_Location_Added = {};\n    console.log(\"data loaded\");\n    const {iv_scale, scale, reject} = scale_data.reduce((acc, sr) => {\n      const invalid = reason => {\n        if (!ilog_set.has(sr.Log)) {\n          sr.Reason += reason;\n          acc.iv_scale.push([sr.Log, sr.Docket, sr.Grade, sr.Length, sr.Diameter, sr.JAS, sr.Location, sr.Date, sr.Reason]);\n        }\n      };\n      const valid = () => acc.scale.push([sr.Log, sr.Docket, sr.Grade, sr.Length, sr.Diameter, sr.JAS, sr.Location, sr.Date]);\n      const reject = () => {\n        if (!rlog_set.has(sr.Log)) {\n          acc.reject.push([sr.Log, sr.Docket, sr.Grade, sr.Length, sr.Diameter, sr.JAS, sr.Date, sr.Reason]);\n        }\n      };\n      sr.Log = parseInt(sr.Log.replace(/\\D/g, ''));\n      if (!log_set.has(sr.Log)) {\n        sr.Date = sr.Date.split('-').reverse().join(\"-\");\n        sr.Location = sr.Location.replace(/ /g, '').toUpperCase();\n        sr.Location = sr.Location.slice(0, 4) + \" \" + sr.Location.slice(-3);\n        if (!location_set.has(sr.Location) && sr.Location && sr.Location != 'TEST' && sr.Location != 'REJE TED') {\n          new_Location.add(sr.Location);\n          new_Location_Added[sr.Location] = sr.Date;\n          location_set.add(sr.Location);\n        }\n        if (isNaN(sr.Docket)) {\n          invalid(\" Invalid Docket Format\");\n        } else if (!docket_set.has(parseInt(sr.Docket))) {\n          invalid(\" Docket Not Found\");\n        } else if (sr.Status === 'Rejected') {\n          reject();\n        } else if (!location_set.has(sr.Location) || sr.Location === 'TEST') {\n          invalid(\" Invalid Location\");\n        } else if (sr.Diameter < 16 || sr.Diameter > 50 || isNaN(sr.Diameter)) {\n          invalid(' Diameter out of range or NaN');\n        } else if (!len_set.has(sr.Length.toString())) {\n          invalid(\" Invalid Length\", sr.Length);\n        } else if (!grade_set.has(sr.Grade)) {\n          invalid(\" Invalid Grade\");\n        } else {\n          valid();\n        }\n      } else {\n        dupes += 1;\n        if (dupes < 5) {\n          showAlert(\"Duplicate Log \" + sr.Log.toString(), 'error');\n        }\n      }\n      return acc;\n    }, {\n      scale: [],\n      iv_scale: [],\n      reject: []\n    });\n    if (dupes > 4) {\n      showAlert(\"Multiple Duplicate Logs - clear raw scaling and start again\", 'error');\n    }\n    console.log(\"finished processing\");\n    if (new_Location.size) {\n      const location_data = Array.from(new_Location).map(item => `('${item}','','${new_Location_Added[item]}')`).join(',').replace(/''/g, 'NULL');\n      await Insert_Yard.run({\n        'data': location_data\n      }).then(() => showAlert(\"Inserted New Locations ${location_data}\", 'success')).error(error => showAlert(error, 'error'));\n      await Location.clear();\n      await Location.run();\n      console.log(\"Inserted Locations\");\n    }\n    if (scale.length > 0) {\n      const data = scale.map(item => `(${item.map(val => `'${val}'`).join(',')})`).join(',');\n      console.log('Valid :', scale.length);\n      await Insert_VScaling.run({\n        'data': data\n      }).then(() => showAlert(\"Found Valid Scaling Entires\", 'success')).catch(() => showAlert(\"Error in adding Valid\", 'error'));\n    }\n    if (iv_scale.length > 0) {\n      const idata = iv_scale.map(item => `(${item.map(val => `'${val}'`).join(',')})`).join(',');\n      console.log('Invalid: ', iv_scale.length);\n      await Insert_Invalid_Scaling.run({\n        'data': idata\n      }).then(() => showAlert(\"Found Invalid Scaling Entires\", 'success')).catch(() => showAlert(\"Error in adding invalid\", 'error'));\n    }\n    if (reject.length > 0) {\n      const rdata = reject.map(item => `(${item.map(val => `'${val}'`).join(',')})`).join(',');\n      console.log('Rejects : ', reject.length);\n      await Insert_Reject_Scaling.run({\n        'data': rdata\n      }).then(() => showAlert(\"Found Reject Scaling Entires\", 'success')).catch(() => showAlert(\"Error in adding reject\", 'error'));\n    }\n    console.log(\"recounting totals\");\n    return 'successfully updated';\n  } catch (error) {\n    showAlert(\"Processing Error\", 'error');\n    return Error();\n  }\n}"
    ],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": []
  },
  "id": "Scaling_Parse_Raw_Scaling.parse_data",
  "deleted": false,
  "gitSyncId": "62c64eab5a06d81bded2fac9_62f1d664624e841f0cc17ea6"
}